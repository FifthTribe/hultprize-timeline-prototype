<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Circles Prototype</title>
    <style>
    .canvas-container {
    float:left;
  width:50%;
 }

.accordion-container {
  float:left;
  display:inline-block;
}
 .accordion {
   width:200px;
 }

.accordion-text {
  display:none;
}
.accordion-text.on {
  display:block;
}
.accordion-item-title a {
  display:block;
  padding:10px;
}
.accordion-item-title a:hover {
  background-color:#999;
}

.clearfix {
  clear:both;
  display:block;
  width:100%;
}
    </style>
  </head>
  <body>
<a href="tri-circle.html">Tri-Circle Prototype</a>

      <h3>Circles Prototype</h3>
      <div class="canvas-container">
        <canvas id="c" width="700" height="700" style="border:1px solid #aaa;"></canvas>
      </div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.6/fabric.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.min.js"></script>



<script id="accordion-template" type="text/x-handlebars-template">
  <div class="accordion-container">
    <div class="accordion">
      {{#each dots.dots}}
      <div class="accordion-item" data-year="{{this.year}}">
        <div class="accordion-item-title"><a href="#">{{this.year}}</a></div>
        <div class="accordion-text">
          <ul>
            <li>Something happened</li>
            <li>Amazing stuff</li>
            <li>Cool text</li>
          </ul>
        </div>
      </div>
      {{/each}}
    </div>
  </div>

</script>

<script>
(function() {
  var milestones = $.getJSON( "milestones.json");
  var totalYears = milestones.years.length;
  var years = milestones.year;
  var circleYears = [];

  fabric.Object.prototype.originX = fabric.Object.prototype.originY = 'center';

  var canvas = this.__canvas = new fabric.Canvas('c', {
    hoverCursor: 'pointer',
    selection: false,
    perPixelTargetFind: true,
    targetFindTolerance: 5
  });
  function createCircle(i, year) {
    var circleYear = new fabric.Circle({
      radius: 1,
      left: canvas.getWidth() / 2,
      top: canvas.getHeight() / 2,
      fill: '',
      stroke: '#CDCDCD',
      hasBorders: false,
      hasControls: false,
      lockMovementX: true,
      lockMovementY: true,
      index: i,
      year: year,
      isCircle: true,
      originalRadius: 26 * i + 90,
      clicked: false
    });
    canvas.add(circleYear);
    circleYears.push(circleYear);

    circleYear.animate('radius', 26 * i + 90, {
          duration: 3000,
          onChange: canvas.renderAll.bind(canvas),
          onComplete: function() {

          },
          easing: fabric.util.ease['easeOutBounce']
        });
  }

  for (var i = 0; i < totalYears; i++) {
    createCircle(i,years[i].year);
    for (var a = 0; a < dots.dots.length; a++){
      if ( dots.dots[a].year === years[i].year){
        var cx = canvas.getWidth() / 2;
        var cy = canvas.getHeight() / 2;
        var randomAngle = Math.round(fabric.util.getRandomInt(-360, 0)/20) * 20;
        var angle = fabric.util.degreesToRadians(randomAngle);
        var radius = i * 26 + 90;
        var x = cx + radius * Math.cos(angle);
        var y = cy + radius * Math.sin(angle);

        //create dot on circle
        var circleDot = new fabric.Circle({
          radius: 0,
          left: x,
          top: y,
          fill: '#EC008C',
          stroke: '',
          hasBorders: false,
          hasControls: false,
          lockMovementX: true,
          lockMovementY: true,
          year: years[i],
          isCircle: false,
          clicked: false
        });
        canvas.add(circleDot);
      }
    }
  }

  var hoverTarget, prevHoverTarget;

  function floatingCircle(circle){
    circle.animate('radius', circle.getRadiusX() == circle.originalRadius ? circle.originalRadius + 5 : circle.originalRadius, {
      duration: 700,
      onChange: canvas.renderAll.bind(canvas),
      onComplete: function(something){
        floatingCircle(circle);
      },
      easing: fabric.util.ease['easeInQuad'],
      abort: function(){
        return !circle.hovering;
      }
    });
    canvas.renderAll();
  }

  function circleWaves(circle){
    var objs = canvas.getObjects();

    for (obj in objs){
      if ( objs[obj].year === circle.year && objs[obj].isCircle === false ){
          var circleDot = objs[obj];
          circleDot.animate('radius', 5, {
            duration: 100,
            onChange: canvas.renderAll.bind(canvas),
            onComplete: function(){
            },
            easing: fabric.util.ease['easeInQuad']
          });
      }
      if ( objs[obj].year === circle.year-1 && objs[obj].isCircle === true ){
          var circleBefore = objs[obj];
          circleBefore.animate('radius', circleBefore.originalRadius-5, {
            duration: 1000,
            onChange: canvas.renderAll.bind(canvas),
            onComplete: function(){
            },
            easing: fabric.util.ease['easeInQuad']
          });
      }
      if ( objs[obj].year === circle.year+1 && objs[obj].isCircle === true){
          var circleAfter = objs[obj];
          circleAfter.animate('radius', circleAfter.originalRadius+5, {
            duration: 1000,
            onChange: canvas.renderAll.bind(canvas),
            onComplete: function(){
            },
            easing: fabric.util.ease['easeInQuad']
          });
      }
    }


  }

  canvas.on('mouse:over', function(e) {
    if ( e.target && e.target.isCircle === true ){
      e.target.set({
        strokeWidth: 3,
        stroke: '#EC008C',
        hovering:true
      });
      circleWaves(e.target);
    }
    canvas.renderAll();
  });

  canvas.on('mouse:out', function(e) {
    var objs = canvas.getObjects();
    for (obj in objs){
      if ( objs[obj].isCircle === false ){
        var circleDot = objs[obj];
        circleDot.animate('radius', 0, {
          duration: 50,
          onChange: canvas.renderAll.bind(canvas),
          onComplete: function(){
          },
          easing: fabric.util.ease['easeInQuad']
        });
      }
      if ( objs[obj].isCircle === true ){
        objs[obj].animate('radius', objs[obj].originalRadius, {
          duration: 1000,
          onChange: canvas.renderAll.bind(canvas),
          onComplete: function(){
          },
          easing: fabric.util.ease['easeInQuad']
        });
      }
    }
    if ( e.target && e.target.isCircle === true && !e.target.clicked ){
      e.target.set({
        strokeWidth: 1,
        stroke: '#CDCDCD',
        hovering:false
      });
    }
    canvas.renderAll();
  });

  canvas.on('mouse:down', function(e) {
    var objs = canvas.getObjects();
    for (obj in objs){
      if ( objs[obj].isCircle === true ){
        objs[obj].set({
          strokeWidth: 1,
          stroke: '#CDCDCD',
          clicked: false
        });
      }
    }
    if ( e.target && e.target.isCircle === true ){
      e.target.set({
        strokeWidth: 3,
        stroke: '#EC008C',
        clicked: true
      });
      var year = e.target.year;
      $('.accordion-text').removeClass('on');
      $('.accordion-item[data-year='+year+'] .accordion-text').addClass('on');
    }
    canvas.renderAll();
  });


  $('.accordion-item').each(function(){
    var accordionItem = $(this);
    $('.accordion-item-title a', accordionItem).on('click',function(){
      $('.accordion-text').removeClass('on')
      $('.accordion-text',accordionItem).addClass('on');
      // highlight canvas object
      var year = parseInt(accordionItem.attr('data-year'));
      var objs = canvas.getObjects();
      for (obj in objs){
        if ( objs[obj].year === year ){
          objs[obj].set({
            strokeWidth: 3,
            stroke: '#EC008C',
            clicked: true
          });
        } else {
          if ( objs[obj].isCircle === true ){
            objs[obj].set({
              strokeWidth: 1,
              stroke: '#EC008C',
              clicked: false
            });
          }
        }
        canvas.renderAll();
      }
    });
  });

})();

</script>


</body>
</html>
